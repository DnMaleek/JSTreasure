<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View client | Treasure</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<style>
    * {
        font-family:sans-serif;
        margin: 0;
    }

    body {
        background-color: rgb(223, 223, 223);
    }

    main {
      
        display: flex;
        justify-content: center;
        margin-top: 20px;

    }

    .container {
        width: 80%;
        
    }

    h2 {
        text-align: center;
        margin-bottom: 10px;
    }



    .bar {
        display: flex;
        justify-content: space-between;
        padding: 20px;
    }

    .bar button {
        padding: 10px 15px;
        border-radius: 8px;
        border: 0px solid rgb(231, 231, 231);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: all 0.3s;

    }

    .bar button:hover {
        border: 1px solid white;
        transform: scale(1.1);
    }

       table, thead, th, td{
        border: 1px solid rgb(148, 148, 148);
        border-collapse: collapse;
        padding: 10px;
    }
    thead{
        background-color: rgb(114, 173, 198);

    }
    tr:hover {
        background-color: rgb(114, 173, 198);
    }
    tr button {
        padding: 2px 10px;
        border: none;
        border-radius: 2px;
        color: white;
    }

    .popbg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height:100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
    }

    .popcard {
        background-color: rgb(231, 231, 231);
        padding: 30px 20px;
        border-radius: 8px;
        width: 400px;
        text-align: center;
        animation: pop 3s ease;
    }

    @keyframes pop {
        form {
            transform: scale(0.8);
            opacity: 0;
        }
        
        to{
            transform:scale(1) ;
            opacity: 1;
        }
    }

    .cancelBtn {
        display: flex;
        flex-direction: column;
        align-items:flex-end;
    }

    #cancelBtn , #cancelBtn2 {
        height: 40px;
        width: 40px;
        font-size: 30px;
        padding: 0;
        border: none;
        color: red;
        background-color: rgb(231, 231, 231);

    }

    .addTransaction {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        gap: 10px;

    }
    .addTransaction > h2 {
        color: rgb(114, 173, 198);
        margin-bottom: 20px;
    }

    .addTransaction > button {
        width: 40%;
        padding: 8px 20px;
        border:2px solid white;
        border-radius: 8px;
        transition: all .3s ease;
    }

    .addTransaction > button:hover{
        transform: scale(1.05) translate(-3px);
    }

    #balance {
        font-weight: bold;
        color: green;
    }

    form > select, input {
        width: 100%;
        height: 40px;
        text-align: center;
        outline: none;
        border: none;
        
    }
    .status {
        position: absolute;
        top: 40px;
        right: 40px;
        z-index: 200;
        color: rgba(255, 255, 255, 0.895);
        padding-inline: 20px;
        padding-top: 10px;
        font-size: 17px;
        padding-bottom: 10px;
        background: rgb(10, 168, 10);
        border: 2px solid rgba(139, 255, 148, 0.76);
        border-radius: 8px 8px 8px 0;
        font-weight: bold;
        display: none;
    }

    #msg {
        font-size: 12px;
    }

    .status.success {
        background: rgb(10, 168, 10);
        border-color: rgba(139, 255, 148, 0.76);
    }

    .status.error {
        background: rgb(200, 40, 40);
        border-color: rgba(255, 150, 150, 0.8);
    }
</style>
<body>
    <div class="status" id="statusBox">
        <p id="msg">This is it</p>
    </div>
    <main>
        <div class="container">
                <h2 id="clientName">Client Name <span onclick="editClient()"><i class="fa-solid fa-user-pen"></i></span></h2>

            <div class="bar">
                <button id="openPopUp"><i class="fa-solid fa-plus"></i> Add Transaction </button>
                <h3 style="font-weight: bold;">Balance: <span id="balance"></span></h3>

            </div>

            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>SN</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>In</th>
                        <th>Out</th>
                        <th>Desc</th>
                        <th>Action</th>

                    </tr>
                </thead>

                <tbody id="data">
                    
                </tbody>
            </table>
        </div>

<!--POP UP FOR ADD TRANSACTION --> 
        <div class="popbg" id="popbg">

            <div class="popcard">
                <div class="cancelBtn" >
                    <button id="cancelBtn">
                       <i class="fa-regular fa-circle-xmark fa-shake"></i>
                    </button>
                </div>

                <form class="addTransaction" id="addTransaction">
                    <h2>Add client transaction here</h2>
                    <select id="transType">
                        <option value="">---Select Transaction Type---</option>
                        <option value="in">In</option>
                        <option value="out">Out</option>
                    </select>
                    <input type="number" id="amount" placeholder="Enter Amount" max="1000000000">
                    <input type="text" name="" id="description" placeholder="Comment (optional)">
                    <button type="submit">Add</button>

                </form>

            </div>

        </div>

        <!--POP UP FOR EDIT CLIENT --> 

        <div class="popbg" id="editPop">
            <div class="popcard">

                  <div class="cancelBtn" >
                    <button id="cancelBtn2">
                       <i class="fa-regular fa-circle-xmark fa-shake"></i>
                    </button>
                </div>

                <form class="addTransaction" id="editUser">

                    <h2>Add client transaction here</h2>
                    <input type="text" id="nameEdt" placeholder="Name">
                    <input type="emai" id="emailEdt" placeholder="Email">
                    <input type="text" id="phoneEdt" placeholder="Phone">
                    <button type="submit">Save</button>

                </form>


            </div>
        </div>


    </main>

    
<script>

            const clientId = window.location.pathname.split('/').pop();
            
            async function loadClient() {

                const nameEdt=document.getElementById('nameEdt')
                const emailEdt=document.getElementById('emailEdt')
                const phoneEdt=document.getElementById('phoneEdt')

                const responce = await fetch(`/view_client/${clientId}` , {
                    method:"POST" ,
                    headers: {'Content-Type': 'application/json'} ,
                });
                
                const client = await responce.json();

                document.getElementById('clientName').innerHTML=client.Name + ' <span onclick="editClient()"><i class="fa-solid fa-user-pen"></i></span>';

                nameEdt.value=client.Name;
                emailEdt.value=client.Email;
                phoneEdt.value=client.Tel;

              

            }
    
            loadClient();
         
            document.getElementById('editUser').addEventListener('submit', async(e)=>{
                    e.preventDefault();

                const nameEdt=document.getElementById('nameEdt').value.trim();
                const emailEdt=document.getElementById('emailEdt').value.trim();
                const phoneEdt=document.getElementById('phoneEdt').value.trim();

                const res= await fetch(`/view_client/${clientId}`,{
                    method:"PUT" ,
                    headers:{
                    "Content-Type":"application/json"
                } ,

                    body:JSON.stringify({
                    Name:nameEdt,
                    Email:emailEdt,
                    Tel:phoneEdt,
                    })
                })


                if(res.ok) {
                    const data = await res.json();
                    await loadClient();
                    document.getElementById('editPop').style.display='none';

                }

                }) 
            
            const popBtn =document.getElementById('openPopUp');
            const popBg =document.getElementById('popbg');
            const cancelBtn =document.getElementById('cancelBtn');


            popBtn.addEventListener('click', ()=>{
                popBg.style.display='flex'
            })
            
            cancelBtn.addEventListener('click',()=>{
                popBg.style.display='none'
            })

            // Submitting Transactions
        const transForm = document.getElementById('addTransaction');

        transForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect values
            const type = document.getElementById('transType').value;
            const amount = Number(document.getElementById('amount').value);
            const desc = document.getElementById('description').value;
            const msg = document.getElementById('msg');
            const statusBox = document.getElementById('statusBox');

             // ðŸ›‘ Validation
            if (!type || amount <= 0) {
                popBg.style.display = 'none';
                msg.innerText = "Please enter a valid transaction";
                statusBox.className = "status error";
                statusBox.style.display = "block";

                setTimeout(() => {
                    statusBox.style.display = "none";
                }, 3000);
                return;
            }
            // Creating data object
            const data = {
                clientId, // This already exists (---Global Variable---)
                type,
                amount,
                desc
            };

            try {
                // Sending Data
                const response = await fetch('/add_transaction', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const res = await response.json();

                    msg.innerText = res.message;

                    statusBox.style.display = "block";
                    statusBox.className = "status success"

                    setTimeout(() => {
                        statusBox.style.display = "none";
                    }, 3000);

                    transForm.reset();
                    popBg.style.display = 'none';

                    await loadTransaction();
                    await displayBalance();
                } else {
                    popBg.style.display = 'none';
                    statusBox.className = "status success"
                    console.error('Server responded with an error!');
                }
            } catch (error) {
                console.error("Error submitting transaction:", error);
                msg.innerText = "Server error. Try again.";
                msg.style.display = "block";
            }
        });

        const loadTransaction = async () => {
            const res = await fetch("/transactions", {
                method:"POST",
                headers: {
                    "Content-Type":"application/json"
                },
                body:JSON.stringify({clientId})
            });

            try {
                const data = await res.json()

                const tableData = document.getElementById('data');
                tableData.innerHTML = "";

                data.forEach((trans, index) => {
                    const trElement = document.createElement('tr');

                    // Assuming trans.date holds the timestamp
                    const dateObj = new Date(trans.date); // convert string to Date object

                    // Extract date (YYYY-MM-DD)
                    const date = dateObj.toLocaleDateString(); // e.g., 12/13/2025

                    // Extract time (HH:MM:SS)
                    const time = dateObj.toLocaleTimeString(); // e.g., 14:03:45

                    trElement.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${date}</td>
                        <td>${time}</td>
                        <td>${trans.in}</td>
                        <td style="color: red">${trans.out}</td>
                        <td>${trans.description}</td>
                        <td>
                            <delete style="background: rgba(200, 50, 50); color: white; cursor: pointer; padding:6px; border-radius: 8px; border:2px solid white;" onclick="deleteTransaction(${trans.id})" >Delete</delete>
                        </td>
                    `;
                    tableData.appendChild(trElement);
                });
            }catch(error) {
                console.log('Error has occur: ', error)
            }
        }

        loadTransaction();

        const displayBalance = async () => {
            const balance = document.getElementById("balance");
            const res = await fetch(`/balance/${clientId}`);

            try {
                const data = await res.json()
                balance.innerText = `TZS ${data.balance.toLocaleString()}`;


               if (data.balance < 0) {
                    balance.style.color = 'red';
                } else if (Number(data.balance) === 0) {
                    balance.style.color = 'blue';
                } else {
                    balance.style.color = 'green';
                }
            }catch(error) {
                console.log(error)
            }
        }

        const deleteTransaction = async (trans_id) => {
                try {
                    const res = await fetch(`/transaction/delete/${trans_id}`, {
                        method: 'DELETE'
                    });

                    const data = await res.json();

                    msg.innerText = data.message;

                    statusBox.style.display = "block";
                    setTimeout(() => {
                        statusBox.style.display = "none";
                    }, 3000);

                    await loadTransaction();
                    await displayBalance();

                    if (!res.ok) {
                        console.error(data);
                    }

                } catch (error) {
                    console.error(error);
                    msg.innerText = "Something went wrong";
                    statusBox.style.display = "block";
                }
            };

        displayBalance();


//Edit client
const editClient = () =>{
    document.getElementById('editPop').style.display='flex';

    document.getElementById('cancelBtn2').addEventListener('click',()=>{
             document.getElementById('editPop').style.display='none'
            })
}



        </script>
</body>
</html>